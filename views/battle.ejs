<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫•u Tr∆∞·ªùng Sinh T·ª≠</title>
    <link rel="stylesheet" href="/css/battle.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>ƒê·∫§U TR∆Ø·ªúNG</h1>

    <div class="battle-container" id="arena">
        <div class="player" id="me">
            <h2 id="my-name"><%= player.name %></h2>
            <div class="hp-container">
                <div class="hp-bar" id="my-hp-bar" style="width: 100%;"></div>
            </div>
            <p>C√¥ng: <%= player.atk %> | T·ªëc: <%= player.spd %></p>
            <div class="status-msg" id="my-status">ƒêang t√¨m ƒë·ªëi th·ªß...</div>
        </div>

        <div class="vs-text">VS</div>

        <div class="player" id="opponent">
            <h2 id="opp-name">ƒêang t√¨m...</h2>
            <div class="hp-container">
                <div class="hp-bar" id="opp-hp-bar" style="width: 100%;"></div>
            </div>
            <p id="opp-stats">???</p>
            <div class="status-msg" id="opp-status">...</div>
        </div>
    </div>

    <div id="logs" style="color: yellow; font-family: monospace; margin-top: 20px;"></div>

<script>
    const socket = io();
    const myData = <%- JSON.stringify(player) %>;
    
    socket.emit('join-match', myData);

    socket.on('match-start', (data) => {
        const isP1 = (socket.id === data.p1.sId);
        const opponent = isP1 ? data.p2 : data.p1;

        document.getElementById('opp-name').innerText = opponent.name;
        document.getElementById('opp-stats').innerText = `C√¥ng: ${opponent.atk} | T·ªëc: ${opponent.spd}`;
        document.getElementById('my-status').innerText = "Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu!";
    });

    socket.on('receive-attack', (data) => {
        const isMeAttacking = (socket.id === data.attackerId);
        const amIP1 = (socket.id === data.p1SId);
        
        const myHP = amIP1 ? data.p1HP : data.p2HP;
        const oppHP = amIP1 ? data.p2HP : data.p1HP;

        updateHP('my-hp-bar', myHP);
        updateHP('opp-hp-bar', oppHP);

        if (isMeAttacking) {
            document.getElementById('my-status').innerText = `üí• B·∫†N ƒê√ÅNH: -${data.damage}`;
            document.getElementById('opp-status').innerText = `...`;
        } else {
            document.getElementById('my-status').innerText = `...`;
            document.getElementById('opp-status').innerText = `üí¢ ƒê·ªêI TH·ª¶ ƒê√ÅNH: -${data.damage}`;
            shakeScreen(); 
        }
    });

    // --- PH·∫¶N B·ªî SUNG HO√ÄN THI·ªÜN ---

    // 1. L·∫Øng nghe th√¥ng b√°o k·∫øt th√∫c t·ª´ Server
    socket.on('battle-end', (data) => {
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i cu·ªëi c√πng tr√™n m√†n h√¨nh
        document.getElementById('my-status').innerText = "K·∫æT TH√öC!";
        document.getElementById('opp-status').innerText = "NG∆Ø·ªúI TH·∫ÆNG: " + data.winner;

        // Hi·ªán th√¥ng b√°o popup
        alert("TR·∫¨N ƒê·∫§U K·∫æT TH√öC!\nNg∆∞·ªùi chi·∫øn th·∫Øng: " + data.winner);

        // Ch·ªù 1 gi√¢y r·ªìi t·ª± ƒë·ªông quay l·∫°i ph√≤ng t·∫≠p (trang ch·ªß)
        setTimeout(() => {
            window.location.href = '/';
        }, 1000);
    });

    function updateHP(barId, hp) {
        const percent = Math.max(0, hp);
        const bar = document.getElementById(barId);
        bar.style.width = percent + "%";
        
        // ƒê·ªïi m√†u ƒë·ªè khi m√°u th·∫•p (< 30%)
        if (percent < 30) {
            bar.style.backgroundColor = "#ff4d4d";
        }
    }

    function shakeScreen() {
        document.body.classList.add('shake');
        setTimeout(() => {
            document.body.classList.remove('shake');
        }, 400);
    }
</script>
</body>
</html>